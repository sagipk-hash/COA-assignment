`timescale 1ns / 1ps

module tb_piped_wallace_mult();

    reg clk = 0;
    reg reset = 1;
    reg [15:0] x, y;
    wire [31:0] prod;

    piped_wallace_mult DUT(
        .clock(clk),
        .reset(reset),
        .x(x),
        .y(y),
        .prod(prod)
    );

    always #5 clk = ~clk; // 100 MHz clock

    integer i;
    reg [31:0] expected;
    reg [15:0] px [0:10], py [0:10];

    initial begin
        $display("=== STARTING WALLACE MULTIPLIER TEST ===");
        #20 reset = 0;

        // pipeline initialization
        for(i=0;i<10;i=i+1) begin
            px[i] = 0;
            py[i] = 0;
        end

        for(i=0; i<200; i=i+1) begin
            x = $random;
            y = $random;

            px[0] = x;
            py[0] = y;

            expected = px[4] * py[4];

            if(i > 6) begin
                if(prod !== expected)
                    $display("FAIL: x=%h y=%h | DUT=%h  Expected=%h",
                             px[4], py[4], prod, expected);
                else
                    $display("PASS: x=%h y=%h | prod=%h",
                              px[4], py[4], prod);
            end

            shift_pipe();
            #10;
        end

        $display("=== TEST FINISHED ===");
        $stop;
    end

    task shift_pipe;
        integer k;
        begin
            for(k=9; k>0; k=k-1) begin
                px[k] = px[k-1];
                py[k] = py[k-1];
            end
        end
    endtask
endmodule
